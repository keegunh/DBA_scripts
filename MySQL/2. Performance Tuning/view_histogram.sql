/*
	MySQL 8.0 버전에서 히스토그램 정보는 칼럼 단위로 관리
	자동으로 수집되지 않고 ANALYZE TABLE ... UPDATE HISTOGRAM 명령을 실행해 수동으로 수집
	MySQL 서버가 시작될 때 딕셔너리의 히스토그램 정보를 information_schema의 column_statistics 테이블로부터 로드

	sampling-rate :
		히스토그램 정보를 수집하기 위해 스캔한 페이지의 비율.
		샘플링 비율이 0.35라면 전체 데이터 페이지의 35%를 스캔해서 이 정보가 수집됐다는 것을 의미

	histogram_type : 
		히스토그램은 버킷 단위로 구분되어 레코드 건수나 컬럼의 범위가 관리됨.
		1. Singleton(싱글톤) 히스토그램은 컬럼이 가지는 값별로 버킷이 할당.
		2. Equi-Height(높이 균형) 히스토그램에서는 개수가 칼럼값의 범위별로 하나의 버킷이 할당.
	
	히스토그램 정보가 없으면 옵티마이저는 데이터가 균등하게 분포돼 있을 것으로 예측. 
	하지만 히스토그램이 있으면 특정 범위의 데이터가 많고 적음을 식별.
	
	MySQL 8.0 서버에서는 인덱스된 칼럼을 검색 조건으로 사용하는 경우 그 칼럼의 히스토그램은 사용하지 않고 실제 Index Dive를 통해 직접 수집한 정보를 활용한다.
	그래서 MySQL 8.0 버전에서 히스토그램은 주로 인덱스되지 않은 컬럼에 대한 데이터 분포도를 참조하는 용도로 사용.
	
	Index Dive : 쿼리의 실행 계획을 수립할 때 사용 가능한 인덱스들로부터 조건절에 일치하는 레코드 건수를 대략 파악하기 위해 옵티마이저가 실제 인덱스들의 B-Tree를 샘플링하는 작업
		이 작업은 어느 정도의 비용이 필요하며 때로는 (IN절에 값이 많이 명시된 경우) 실행 계획 수립만으로도 상당한 Index Dive를 실행하고 비용도 그만큼 커진다.
	
*/

-- 히스토그램 정보 조회
SELECT schema_name
     , table_name
	 , column_name
	 , histogram
  FROM information_schema.column_statistics
;

-- 히스토그램 정보 추가
ANALYZE TABLE schema_name.table_name UPDATE HISTOGRAM ON column_name, column_name ... ;

-- 히스토그램 정보 삭제
-- 딕셔너리 내용만 삭제하기 때문에 삭제 자체는 다른 쿼리 처리에 영향이 없으나 실행 계획이 달라질 수 있음.
ANALYZE TABLE schema_name.table_name DROP HISTOGRAM ON column_name, column_name ... ;

-- 히스토그램을 삭제하지 않고 MySQL 옵티마이저가 히스토그램을 사용하지 않게 하려면 다음과 같이 optimizer_switch 시스템 변수의 값을 변경
SET GLOBAL optimizer_switch='condition_fanout_filter=off';	-- 전체 커넥션에서 실행된 쿼리가 히스토그램을 사용하지 않게 설정
SET SESSION optimizer_switch='condition_fanout_filter=off';	-- 현재 커넥션에서 실행되는 쿼리만 히스토그램을 사용하지 않게 설정
SELECT /*+ SET_VAR(optimizer_switch='condition_fanout_filter=off') */ * FROM ...;	-- 해당 쿼리만 히스토그램을 사용하지 않게 설정

/* 히스토그램 예시
{
   "buckets":[
      [
         "base64:type254:MTAwMDAwMTQ=",
         "base64:type254:MzAwMDIz",
         0.010277822386381886,
         51
      ],
      [
         "base64:type254:MzAwMDI0",
         "base64:type254:MzAwMDM3",
         0.019752689898827686,
         14
      ],
      [
         "base64:type254:MzAwMDM4",
         "base64:type254:MzAwMDU0",
         0.02940153096729297,
         16
      ],
      [
         "base64:type254:MzAwMDU1",
         "base64:type254:MzAwMDg4",
         0.03854183394893207,
         29
      ],
      [
         "base64:type254:MzAwMDg5",
         "base64:type254:MzAwMTA0",
         0.05113484288849633,
         14
      ],
      [
         "base64:type254:MzAwMTA1",
         "base64:type254:MzAwMTIx",
         0.060863979444355225,
         15
      ],
      [
         "base64:type254:MzAwMTIy",
         "base64:type254:MzAwMTM1",
         0.06893367592741288,
         13
      ],
      [
         "base64:type254:MzAwMTM2",
         "base64:type254:MzAwMTQ0",
         0.07835501311492961,
         7
      ],
      [
         "base64:type254:MzAwMTQ1",
         "base64:type254:MzAwMTUw",
         0.08942240779401531,
         6
      ],
      [
         "base64:type254:MzAwMTUx",
         "base64:type254:MzAwMTYz",
         0.09870991916920936,
         13
      ],
      [
         "base64:type254:MzAwMTY0",
         "base64:type254:MzAwMTc1",
         0.10861302928108774,
         12
      ],
      [
         "base64:type254:MzAwMTc2",
         "base64:type254:MzAwMjg0",
         0.11858305229912745,
         59
      ],
      [
         "base64:type254:MzAwMjg1",
         "base64:type254:MzAwNjI2",
         0.12841924950484448,
         153
      ],
      [
         "base64:type254:MzAwNjI4",
         "base64:type254:MzAxMDMw",
         0.13658262405652802,
         165
      ],
      [
         "base64:type254:MzAxMDMx",
         "base64:type254:MzAxMDU5",
         0.14881430330282105,
         23
      ],
      [
         "base64:type254:MzAxMDYw",
         "base64:type254:MzAxMjMx",
         0.15804828435308602,
         100
      ],
      [
         "base64:type254:MzAxMjMy",
         "base64:type254:MzAxNjM1",
         0.16783095123387398,
         164
      ],
      [
         "base64:type254:MzAxNjM3",
         "base64:type254:MzAxODU0",
         0.1778009742519137,
         119
      ],
      [
         "base64:type254:MzAxODU1",
         "base64:type254:MzAxOTEx",
         0.18629891333440393,
         35
      ],
      [
         "base64:type254:MzAxOTEy",
         "base64:type254:MzAxOTM3",
         0.19750013382581233,
         20
      ],
      [
         "base64:type254:MzAxOTM4",
         "base64:type254:MzAyMDEw",
         0.20743000910015524,
         48
      ],
      [
         "base64:type254:MzAyMDEx",
         "base64:type254:MzAyMTcw",
         0.2173331192120336,
         107
      ],
      [
         "base64:type254:MzAyMTcx",
         "base64:type254:MzAyMjI2",
         0.22779829773566726,
         34
      ],
      [
         "base64:type254:MzAyMjI3",
         "base64:type254:MzAyMzE2",
         0.23728654782934533,
         50
      ],
      [
         "base64:type254:MzAyMzE3",
         "base64:type254:MzAyMzkz",
         0.24816658637117928,
         56
      ],
      [
         "base64:type254:MzAyMzk0",
         "base64:type254:MzAyNDU4",
         0.25580804025480436,
         40
      ],
      [
         "base64:type254:MzAyNDYw",
         "base64:type254:MzAyNTEx",
         0.26587174134146996,
         34
      ],
      [
         "base64:type254:MzAyNTEz",
         "base64:type254:MzAyNTcy",
         0.2764439805149617,
         47
      ],
      [
         "base64:type254:MzAyNTcz",
         "base64:type254:MzAyNjM5",
         0.2855709009153686,
         37
      ],
      [
         "base64:type254:MzAyNjQx",
         "base64:type254:MzAyNzE0",
         0.2973074246560677,
         43
      ],
      [
         "base64:type254:MzAyNzE1",
         "base64:type254:MzAyNzMx",
         0.3064744928001713,
         16
      ],
      [
         "base64:type254:MzAyNzMy",
         "base64:type254:MzAyNzQ4",
         0.3157352390129008,
         13
      ],
      [
         "base64:type254:MzAyNzQ5",
         "base64:type254:MzAyNzg1",
         0.3259862962368182,
         31
      ],
      [
         "base64:type254:MzAyNzg2",
         "base64:type254:MzAyODEx",
         0.33583587602376747,
         16
      ],
      [
         "base64:type254:MzAyODEy",
         "base64:type254:MzAyODQy",
         0.34465499705583214,
         28
      ],
      [
         "base64:type254:MzAyODQz",
         "base64:type254:MzAyOTA5",
         0.35489267169851724,
         47
      ],
      [
         "base64:type254:MzAyOTEw",
         "base64:type254:MzAyOTI1",
         0.3657459450778866,
         11
      ],
      [
         "base64:type254:MzAyOTI2",
         "base64:type254:MzAyOTg1",
         0.3749130132219903,
         39
      ],
      [
         "base64:type254:MzAyOTg3",
         "base64:type254:MzAzMDQ0",
         0.3866763021251539,
         36
      ],
      [
         "base64:type254:MzAzMDQ1",
         "base64:type254:MzAzMDY0",
         0.39425084310261765,
         17
      ],
      [
         "base64:type254:MzAzMDY2",
         "base64:type254:MzAzMTA0",
         0.4049702906696644,
         25
      ],
      [
         "base64:type254:MzAzMTA3",
         "base64:type254:MzAzMTQy",
         0.41436486269471656,
         30
      ],
      [
         "base64:type254:MzAzMTQz",
         "base64:type254:MzAzMjI4",
         0.42472298056849206,
         53
      ],
      [
         "base64:type254:MzAzMjI5",
         "base64:type254:MzAzMjY3",
         0.433956961618757,
         29
      ],
      [
         "base64:type254:MzAzMjY4",
         "base64:type254:MzAzMjk1",
         0.4447433220919651,
         19
      ],
      [
         "base64:type254:MzAzMjk2",
         "base64:type254:MzAzMzUw",
         0.4543118676730368,
         36
      ],
      [
         "base64:type254:MzAzMzUx",
         "base64:type254:MzAzMzcw",
         0.4656335313955356,
         14
      ],
      [
         "base64:type254:MzAzMzcx",
         "base64:type254:MzAzMzgx",
         0.47770461966704136,
         9
      ],
      [
         "base64:type254:MzAzMzgy",
         "base64:type254:MzAzMzk0",
         0.4836598683154007,
         12
      ],
      [
         "base64:type254:MzAzMzk1",
         "base64:type254:MzAzNDI3",
         0.49393769070178256,
         21
      ],
      [
         "base64:type254:MzAzNDI4",
         "base64:type254:MzAzNDQx",
         0.5037738879074996,
         10
      ],
      [
         "base64:type254:MzAzNDQy",
         "base64:type254:MzAzNDU5",
         0.5134494941384294,
         12
      ],
      [
         "base64:type254:MzAzNDYx",
         "base64:type254:MzAzNDY4",
         0.5245035062362828,
         6
      ],
      [
         "base64:type254:MzAzNDY5",
         "base64:type254:MzAzNTA5",
         0.5349686847599165,
         30
      ],
      [
         "base64:type254:MzAzNTEw",
         "base64:type254:MzAzNTM5",
         0.543279267705155,
         23
      ],
      [
         "base64:type254:MzAzNTQz",
         "base64:type254:MzAzNTQ3",
         0.5517102938814838,
         5
      ],
      [
         "base64:type254:MzAzNTQ4",
         "base64:type254:MzAzNTY1",
         0.5641560944274931,
         15
      ],
      [
         "base64:type254:MzAzNTY2",
         "base64:type254:MzAzNTgz",
         0.5739655264707457,
         15
      ],
      [
         "base64:type254:MzAzNTky",
         "base64:type254:MzAzNjE2",
         0.581566832610674,
         19
      ],
      [
         "base64:type254:MzAzNjE3",
         "base64:type254:MzAzNjI3",
         0.5926609924522241,
         11
      ],
      [
         "base64:type254:MzAzNjI4",
         "base64:type254:MzAzNjQ5",
         0.6015737915529147,
         18
      ],
      [
         "base64:type254:MzAzNjUw",
         "base64:type254:MzAzNjcx",
         0.6126545688132327,
         16
      ],
      [
         "base64:type254:MzAzNjcy",
         "base64:type254:MzAzNzE2",
         0.6224238531127884,
         34
      ],
      [
         "base64:type254:MzAzNzE3",
         "base64:type254:MzAzNzI2",
         0.6291552914726193,
         9
      ],
      [
         "base64:type254:MzAzNzI3",
         "base64:type254:MzAzNzM1",
         0.6458567528504898,
         8
      ],
      [
         "base64:type254:MzAzNzM3",
         "base64:type254:MzAzNzQx",
         0.6509153685562872,
         4
      ],
      [
         "base64:type254:MzAzNzQy",
         "base64:type254:MzAzNzQ0",
         0.6645789839944328,
         3
      ],
      [
         "base64:type254:MzAzNzQ1",
         "base64:type254:MzAzNzUx",
         0.6719795514158771,
         6
      ],
      [
         "base64:type254:MzAzNzUy",
         "base64:type254:MzAzNzg5",
         0.6819763395963814,
         33
      ],
      [
         "base64:type254:MzAzNzkw",
         "base64:type254:MzAzODA5",
         0.6915181200149885,
         19
      ],
      [
         "base64:type254:MzAzODEw",
         "base64:type254:MzAzODE3",
         0.7033215566618489,
         8
      ],
      [
         "base64:type254:MzAzODE4",
         "base64:type254:MzAzODM5",
         0.7115518441196939,
         18
      ],
      [
         "base64:type254:MzAzODQw",
         "base64:type254:MzAzODc1",
         0.7212542155130882,
         22
      ],
      [
         "base64:type254:MzAzODc2",
         "base64:type254:MzAzOTA4",
         0.7311439430437343,
         26
      ],
      [
         "base64:type254:MzAzOTA5",
         "base64:type254:MzAzOTE2",
         0.7408463144371287,
         7
      ],
      [
         "base64:type254:MzAzOTE3",
         "base64:type254:MzAzOTI1",
         0.750347947112039,
         8
      ],
      [
         "base64:type254:MzAzOTI2",
         "base64:type254:MzAzOTUx",
         0.7597960494620203,
         21
      ],
      [
         "base64:type254:MzAzOTUy",
         "base64:type254:MzAzOTcz",
         0.7701006370108666,
         20
      ],
      [
         "base64:type254:MzAzOTc0",
         "base64:type254:MzAzOTg2",
         0.780552432953268,
         12
      ],
      [
         "base64:type254:MzAzOTg3",
         "base64:type254:MzAzOTk5",
         0.7909774637332049,
         11
      ],
      [
         "base64:type254:MzA0MDAw",
         "base64:type254:MzA0MDAz",
         0.7997430544403404,
         4
      ],
      [
         "base64:type254:MzA0MDA0",
         "base64:type254:MzA0MDEz",
         0.8090305658155345,
         10
      ],
      [
         "base64:type254:MzA0MDE0",
         "base64:type254:MzA0MDIz",
         0.8209009153685562,
         10
      ],
      [
         "base64:type254:MzA0MDI0",
         "base64:type254:MzA0MDQz",
         0.8290375247577753,
         19
      ],
      [
         "base64:type254:MzA0MDQ0",
         "base64:type254:MzA0MDU3",
         0.8395829987688025,
         13
      ],
      [
         "base64:type254:MzA0MDU4",
         "base64:type254:MzA0MDcx",
         0.8501284727798297,
         12
      ],
      [
         "base64:type254:MzA0MDcy",
         "base64:type254:MzA0MDc4",
         0.8597104009421337,
         7
      ],
      [
         "base64:type254:MzA0MDgw",
         "base64:type254:MzA0MTA1",
         0.8692655639419731,
         24
      ],
      [
         "base64:type254:MzA0MTIy",
         "base64:type254:MzA1MDIy",
         0.8790348482415288,
         61
      ],
      [
         "base64:type254:MzA1MDIz",
         "base64:type254:MzA1MTA5",
         0.8895803222525561,
         11
      ],
      [
         "base64:type254:MzA1MTEw",
         "base64:type254:MzA1MTI0",
         0.8984797387720144,
         15
      ],
      [
         "base64:type254:MzA1MTI1",
         "base64:type254:MzA1MTMz",
         0.9088110914833253,
         9
      ],
      [
         "base64:type254:MzA1MTM0",
         "base64:type254:MzA1MTUz",
         0.9195037738879075,
         19
      ],
      [
         "base64:type254:MzA1MTU0",
         "base64:type254:MzA1MTY3",
         0.928710989775708,
         13
      ],
      [
         "base64:type254:MzA1MTY4",
         "base64:type254:MzA1MTgy",
         0.9384267437503345,
         14
      ],
      [
         "base64:type254:MzA1MTgz",
         "base64:type254:MzA1MjE3",
         0.9480354370751031,
         35
      ],
      [
         "base64:type254:MzA1MjE4",
         "base64:type254:MzA1MjMy",
         0.9578314865371232,
         15
      ],
      [
         "base64:type254:MzA1MjMz",
         "base64:type254:MzA1MjUw",
         0.9682565173170601,
         18
      ],
      [
         "base64:type254:MzA1MjUx",
         "base64:type254:MzA1Mjgz",
         0.9776912370858091,
         29
      ],
      [
         "base64:type254:MzA1Mjg1",
         "base64:type254:MzA1MzA4",
         0.987768320753707,
         24
      ]
   ],
   "data-type":"string",
   "null-values":0.012231679246293025,
   "collation-id":255,
   "last-updated":"2022-08-17 06:22:46.988876",
   "sampling-rate":0.43995340013585765,
   "histogram-type":"equi-height",
   "number-of-buckets-specified":100
}
*/