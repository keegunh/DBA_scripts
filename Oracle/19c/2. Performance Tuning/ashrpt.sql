-- Active Session History
-- 활동 중인 세션 정보를 샘플링해서 ASH 버퍼에 저장
-- V$ACTIVE_SESSION_HISTORY 뷰를 이용해 ASH 버퍼에 젖아된 세션 히스토리 정보를 조회

-- 방법 1. 서버 디렉토리에 리포트 파일 생성 - SQLPLUS로 실행
@?/rdbms/admin/ashrpt.sql


-- 방법 2-1. 쿼리 결과로 리포트 생성 - DBID, INSTANCE_NUMBER, SNAP_TIME 확인
ALTER SESSION SET NLS_TIMESTAMP_FORMAT ='YYYYMMDD HHMISSXFF AM';
SELECT MIN(BEGIN_INTERVAL_TIME) AS START_SNAP_TIME
     , MAX(END_INTERVAL_TIME) AS END_SNAP_TIME
  FROM DBA_HIST_ASH_SNAPSHOT
 WHERE BEGIN_INTERVAL_TIME BETWEEN TO_DATE('202312210900', 'YYYYMMDDHH24MISS')
   AND TO_DATE('202312211400', 'YYYYMMDDHH24MISS')
   AND INSTANCE_NUMBER = 1;
   
-- 방법 2-2. 쿼리 결과로 리포트 생성 - AWR REPORT HTML로 생성
SELECT OUTPUT FROM TABLE(DBMS_WORKLOAD_REPOSITORY.ASH_REPORT_HTML(:dbid, :instance_number, :start_snap_time, :end_snap_time));
SELECT OUTPUT FROM TABLE(DBMS_WORKLOAD_REPOSITORY.ASH_REPORT_HTML(2271455618, 1, SYSDATE-30/1440, SYSDATE-1/1440));
SELECT OUTPUT FROM TABLE(DBMS_WORKLOAD_REPOSITORY.ASH_REPORT_HTML(2271455618, 1, TO_DATE('2023-12-22 14:18:34', 'YYYY-MM-DD HH24:MI:SS', TO_DATE('2023-12-22 14:47:34', 'YYYY-MM-DD HH24:MI:SS')));

-- 방법 2-2. 쿼리 결과로 리포트 생성 - AWR REPORT TEXT로 생성
SELECT OUTPUT FROM TABLE(DBMS_WORKLOAD_REPOSITORY.ASH_REPORT_TEXT(:dbid, :instance_number, :start_snap_time, :end_snap_time));
SELECT OUTPUT FROM TABLE(DBMS_WORKLOAD_REPOSITORY.ASH_REPORT_TEXT(2271455618, 1, SYSDATE-30/1440, SYSDATE-1/1440));
SELECT OUTPUT FROM TABLE(DBMS_WORKLOAD_REPOSITORY.ASH_REPORT_TEXT(2271455618, 1, TO_DATE('2023-12-22 14:18:34', 'YYYY-MM-DD HH24:MI:SS', TO_DATE('2023-12-22 14:47:34', 'YYYY-MM-DD HH24:MI:SS')));
